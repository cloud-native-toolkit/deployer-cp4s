---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: cp4s-deploy
spec:
  params:
    - name: namespace
      type: string
      description: Namespace for CP4S deployment
      default: "cp4s"
    - name: cp4s-version
      type: string
      description: CP4S version
      default: "1.10"
    - name: ibm-entitlement-key
      description: IBM entitlement key. If not set, will use secret manger. 
      type: string
      default: "false"
    - name: verify-url
      description: (Required) IBM Security Verify URL
      type: string
    - name: verify-client-id
      description: (Required) IBM Security Verify Client ID 
      type: string
    - name: verify-client-secret
      description: (Required) IBM Security Verify Client secret  
      type: string
    - name: verify-admin-user
      description: (Required) Admin user email
      type: string
  tasks:
    - name: get-sources
      taskSpec:
        steps:
        - name: git-clone-step
          image: alpine/git
          args:
            - clone
            - "https://github.com/cloud-native-toolkit/deployer-cp4s.git"
            - "$(workspaces.ws.path)/cp4s-source"
        workspaces:
          - name: ws
      workspaces:
        - name: ws
          workspace: cp4s-ws
    - name: install-serverless
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF
            ---
            apiVersion: v1
            kind: Namespace
            metadata:
              name: openshift-serverless
            ---
            apiVersion: operators.coreos.com/v1
            kind: OperatorGroup
            metadata:
              name: serverless-operators
              namespace: openshift-serverless
            spec: {}
            ---
            apiVersion: operators.coreos.com/v1alpha1
            kind: Subscription
            metadata:
              name: serverless-operator
              namespace: openshift-serverless
            spec:
              channel: stable 
              name: serverless-operator 
              source: redhat-operators 
              sourceNamespace: openshift-marketplace 
            EOF
    - name: wait-for-serverless-crd
      runAfter:
        - install-serverless
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              #!/usr/bin/env bash
              serverlessCSV=$(oc get csv -o=custom-columns=NAME:.metadata.name | grep serverless)
              while [[ "$serverlessCSV" == "" ]]
              do 
                  echo "Waiting for crd to install..."
                  serverlessCSV=$(oc get csv -o=custom-columns=NAME:.metadata.name | grep serverless)
                  sleep 5
              done
              echo "crd installed!"
              status=$(oc get csv/$serverlessCSV -o=custom-columns=PHASE:.status.phase --no-headers)
              while [[ "$status" != "Succeeded" ]]
              do
                  status=$(oc get csv/$serverlessCSV -o=custom-columns=PHASE:.status.phase --no-headers)
                  echo "Waiting for crd to reach success status..."
                  sleep 15
              done
    - name: install-knative-serving
      taskRef:
        kind: Task
        name: ibm-pak
      runAfter:
        - wait-for-serverless-crd
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF
            apiVersion: operator.knative.dev/v1beta1
            kind: KnativeServing
            metadata:
                name: knative-serving
                namespace: knative-serving
            spec:
                high-availability:
                    replicas: 2
            EOF
    - name: add-namespace
      runAfter:
        - install-knative-serving
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |
            oc apply -f - <<EOF 
            kind: Namespace
            apiVersion: v1
            metadata:
              name: $(params.namespace)
            EOF
    - name: get-ibm-entitlement-key
      params:
        - name: KEY_ID
          value: 968d7819-f2c5-7b67-c420-3c6bfd51521e
        - name: SECRETS_MANAGER_ENDPOINT_URL
          value: >-
            https://afa20521-cd75-4864-843f-e59fd0ffd49d.us-south.secrets-manager.appdomain.cloud
      taskRef:
        kind: Task
        name: ibmcloud-secrets-manager-get
    - name: set-retrieved-entitlement-key
      when:
        - input: "$(params.ibm-entitlement-key)"
          operator: in
          values: ["false"]
      runAfter:
        - get-ibm-entitlement-key
        - add-namespace
      params:
        - name: ibm-entitlement-key
          value: $(tasks.get-ibm-entitlement-key.results.secret-value)
        - name: namespace
          value: "$(params.namespace)"
      taskSpec:
        params:
          - name: ibm-entitlement-key
          - name: namespace
        steps:
          - name: set-entitlement-key
            image: quay.io/openshift/origin-cli:4.10
            script: |
              #!/usr/bin/env bash
              oc get secret "ibm-entitlement-key" -n $(params.namespace)
              if [ $? -eq 0 ]; then
                  echo "Deleting existing secret..."
                  oc delete secrets "ibm-entitlement-key" -n $(params.namespace)
              fi
              oc create secret docker-registry "ibm-entitlement-key" -n $(params.namespace) "--docker-server=cp.icr.io" "--docker-username=cp" "--docker-password=$(params.ibm-entitlement-key)"
    - name: set-provided-entitlement-key
      runAfter:
        - add-namespace
      when:
        - input: "$(params.ibm-entitlement-key)"
          operator: notin
          values: ["false"]
      params:
        - name: ibm-entitlement-key
          value: "$(params.ibm-entitlement-key)"
        - name: namespace
          value: "$(params.namespace)"
      taskSpec:
        params:
          - name: ibm-entitlement-key
          - name: namespace
        steps:
          - name: set-entitlement
            image: quay.io/openshift/origin-cli:4.10
            script: |
              #!/usr/bin/env bash
              oc get secret "ibm-entitlement-key" -n $(params.namespace)
              if [ $? -eq 0 ]; then
                  echo "Deleting existing secret..."
                  oc delete secrets "ibm-entitlement-key" -n $(params.namespace)
              fi
              oc create secret docker-registry "ibm-entitlement-key" -n $(params.namespace) "--docker-server=cp.icr.io" "--docker-username=cp" "--docker-password=$(params.ibm-entitlement-key)"
    - name: install-operator-catalog
      runAfter:
        - set-provided-entitlement-key
        - set-retrieved-entitlement-key
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
            oc apply -f - <<EOF
            apiVersion: operators.coreos.com/v1alpha1
            kind: CatalogSource
            metadata:
                name: ibm-operator-catalog
                namespace: openshift-marketplace
            spec:
                displayName: ibm-operator-catalog
                publisher: IBM Content
                sourceType: grpc
                image: icr.io/cpopen/ibm-operator-catalog
                updateStrategy:
                    registryPoll:
                      interval: 45m
            EOF
    - name: wait-for-operator
      runAfter:
        - install-operator-catalog
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              status=$(oc get pod -lolm.catalogSource=ibm-operator-catalog -n openshift-marketplace -o=custom-columns=STATUS:.status.phase --no-headers)

              while [[ "$status" != "Running" ]]
              do
                  status=$(oc get pod -lolm.catalogSource=ibm-operator-catalog -n openshift-marketplace -o=custom-columns=STATUS:.status.phase --no-headers)
                  echo "Waiting for catalog to install..."
                  sleep 15
              done
    - name: install-cp4s-operator
      runAfter:
        - wait-for-operator
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              #!/usr/bin/env bash
              oc apply -f - <<EOF 
              apiVersion: operators.coreos.com/v1
              kind: OperatorGroup
              metadata:
                   name: cp4s-operator-group
                   namespace: $(params.namespace)
              spec:
                   targetNamespaces:
                      - $(params.namespace)
              EOF
    - name: install-cp4s-subscription
      runAfter:
        - install-cp4s-operator
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              oc apply -f - <<EOF 
              apiVersion: operators.coreos.com/v1alpha1
              kind: Subscription
              metadata:
                   name: ibm-cp-security-operator
                   namespace: $(params.namespace)
              spec:
                   channel: v1.10
                   installPlanApproval: Automatic
                   name: ibm-cp-security-operator
                   source: ibm-operator-catalog
                   sourceNamespace: openshift-marketplace
              EOF
    - name: wait-for-cp4s-operator
      runAfter:
        - install-cp4s-subscription
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              #!/usr/bin/env bash
              deployStatus=$(oc get pod -lname=ibm-cp-security-operator -n $(params.namespace) -o=custom-columns=STATUS:.status.phase --no-headers)

              while [[ "$deployStatus" != "Running" ]]
              do
                  echo "Waiting on operator to start..."
                  deployStatus=$(oc get pod -lname=ibm-cp-security-operator -n $(params.namespace) -o=custom-columns=STATUS:.status.phase --no-headers)
                  sleep 10
              done
              echo "Operator started!"
    - name: install-cp4s-threat-management
      runAfter:
        - wait-for-cp4s-operator
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              oc apply -f - <<EOF 
              apiVersion: isc.ibm.com/v1
              kind: CP4SThreatManagement
              metadata:
                   name: threatmgmt
                   namespace: $(params.namespace)
              spec:
                   acceptLicense: true
                   basicDeploymentConfiguration:
                       adminUser: $(params.verify-admin-user)
                       domain: ""
                       storageClass: ""
                   extendedDeploymentConfiguration:
                       airgapInstall: false
                       clusterProxy: false
                       backupStorageClass: ""
                       backupStorageSize: ""
                       imagePullPolicy: IfNotPresent
                       repository: cp.icr.io/cp/cp4s
                       repositoryType: entitled
                       roksAuthentication: false
                       CSNamespace: ibm-common-services
                   threatManagementCapabilities:
                       deployDRC: true
                       deployRiskManager: true
                       deployThreatInvestigator: true
              EOF
    - name: wait-for-threat-management
      runAfter:
        - install-cp4s-threat-management
      timeout: "3h15m"
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              #!/usr/bin/env bash
              status=$(oc get CP4SThreatManagement threatmgmt -n $(params.namespace) -o jsonpath='{.status.conditions}' | jq '.[0].type')

              while [[ "$status" != '"Success"' ]]
              do
                status=$(oc get CP4SThreatManagement threatmgmt -n $(params.namespace) -o jsonpath='{.status.conditions}' | jq '.[0].type')
                echo "Waiting for Threat Management to install. This could take up to an hour and a half..."
                sleep 120   
              done

              echo "CP4S installed!"
    - name: update-certs
      runAfter:
        - wait-for-threat-management
      timeout: "3h15m"
      params:
        - name: namespace
          value: "$(params.namespace)"
      taskSpec:
        params:
          - name: namespace
        steps:
          - name: set-entitlement
            image: quay.io/openshift/origin-cli:4.10
            script: |
              mkdir ~/hostname_update

              cd ~/hostname_update


              echo "Creating script to update certificates for common-services"

              cat <<EOF > hostname_update.sh

              echo "Checking all the pre-reqs"


              echo "Checking for an authenticated oc CLI..."

              TOKENS=$(oc whoami >/dev/null 2>&1)

              if [ $? -eq 1 ]

              then
                echo "You must be logged in with oc first"
                exit 1
              else
                echo "Authenticated oc CLI found"
              fi


              echo "Checking for tls.crt..."

              if [ ! -f "./tls.crt" ]

              then
                echo "No tls.crt found"
                echo "Please put the TLS certificate in tls.crt in the current directory"
                exit 1
              else
                echo "Found tls.crt"
              fi


              echo "Checking for tls.key..."

              if [ ! -f "./tls.key" ]

              then
                echo "No tls.key found"
                echo "Please put the TLS key in tls.key in the current directory"
                exit 1
              else
                echo "Found tls.key"
              fi


              echo "Checking for ca.crt..."

              if [ ! -f "./ca.crt" ]

              then
                echo "No ca.crt found"
                echo "Please put the CA public certificate in ca.crt in the current directory"
                exit 1
              else
                echo "Found ca.crt"
              fi


              echo "Updating the foundational services route"


              echo "Taking ownership of the certificate from foundational services"

              oc -n ibm-common-services patch managementingress default --type merge --patch '{"spec":{"ignoreRouteCert":true}}'


              echo "Updating certificate..."

              oc -n ibm-common-services delete certificates.certmanager.k8s.io route-cert

              oc -n ibm-common-services delete secret route-tls-secret

              oc -n ibm-common-services create secret generic route-tls-secret --from-file=ca.crt=ca.crt  --from-file=tls.crt=tls.crt  --from-file=tls.key=tls.key


              echo "Deleting ibmcloud-cluster-ca-cert to trigger a certificate refresh..."

              oc delete secret ibmcloud-cluster-ca-cert -n ibm-common-services


              echo "Restarting the auth-idp pods..."

              oc -n ibm-common-services delete pod -l app=auth-idp


              echo "Deleting the management-ingress-ibmcloud-cluster-ca-cert
              secret..."

              oc -n $(params.namespace) delete secret management-ingress-ibmcloud-cluster-ca-cert


              echo "Creating operand request file to apply"


              echo "apiVersion: operator.ibm.com/v1alpha1

              kind: OperandRequest

              metadata:
                name: register-new-ca-cert
                namespace: $(params.namespace)
              spec:
                requests:
                  - operands:
                      - name: ibm-management-ingress-operator
                    registry: common-service
                    registryNamespace: ibm-common-services" > operand_request.yaml

              echo "Creating a new operand request that will trigger the recreation of the management-ingress secret..."

              oc apply -f operand_request.yaml


              echo "Wait for the operand request to be ready..."

              oc wait --for condition=ready --timeout=120s operandrequest -n $(params.namespace) register-new-ca-cert


              echo "Waiting for up to 30 minutes for the auth-idp pods to restart..."

              oc wait --for condition=ready --timeout=900s pod -l app=auth-idp -n ibm-common-services


              echo "Deleting the operand request now secret is up..."

              oc delete operandrequest -n $(params.namespace) register-new-ca-cert


              echo "Setup complete"

              EOF


              chmod +x hostname_update.sh


              echo "Extracting cluster's TLS certs"

              pwd


              oc extract secret/$(oc get ingresscontroller.operator default -n openshift-ingress-operator -o jsonpath='{.spec.defaultCertificate.name}') -n openshift-ingress --to=. --keys=tls.crt,tls.key --confirm


              csplit -s -z -f cert- tls.crt '/-----BEGIN CERTIFICATE-----/'  '{*}'


              ls -ltr


              mv tls.crt tls.crt.original

              mv cert-00 tls.crt

              cat cert-01 cert-02 > ca.crt


              echo "Updating common services' certs"

              ./hostname_update.sh


              oc -n $(params.namespace) delete secret custom-tls-secret --ignore-not-found=true

              oc create secret generic custom-tls-secret --from-file=ca.crt=./ca.crt --from-file=tls.crt=./tls.crt --from-file=tls.key=./tls.key -n $(params.namespace)
    - name: admin-login-credential
      runAfter:
        - update-certs
      taskRef:
        kind: Task
        name: ibm-pak
      params:
        - name: SCRIPT
          value: |-
              CP4S_NAMESPACE=$(params.namespace)
              FS_NAMESPACE=$(oc get cm cp4s-config -o jsonpath="{.data.CSNamespace}" -n $CP4S_NAMESPACE)
              url=$(oc get routes cp-console -n $FS_NAMESPACE -o jsonpath='{.spec.host}' | awk '{print $1}')
              username=$(oc get secret platform-auth-idp-credentials -o jsonpath='{.data.admin_username}' -n $FS_NAMESPACE | base64 -d | awk '{print $1}')
              password=$(oc get secret platform-auth-idp-credentials -o jsonpath='{.data.admin_password}' -n $FS_NAMESPACE | base64 -d | awk '{print $1}')
              echo "***** Admin login info *****"
              echo "URL: $url"
              echo "Username: $username"
              echo "Password: $password"
    - name: cp4s-to-verify
      runAfter:
        - get-sources
        - admin-login-credential
      params:
        - name: namespace
          value: "$(params.namespace)"
        - name: verify-url
          value: "$(params.verify-url)"
        - name: verify-client-id
          value: "$(params.verify-client-id)"
        - name: verify-client-secret
          value: "$(params.verify-client-secret)"
      taskSpec:
        params:
          - name: namespace
          - name: verify-url
          - name: verify-client-id
          - name: verify-client-secret
        steps:
          - name: set-entitlement
            image: quay.io/congxdev/ibm-pak-ubi:latest
            script: |
              microdnf install -y libxml2 libxslt && microdnf clean all
              export FQDN=$(oc get CP4SThreatManagement threatmgmt -n $(params.namespace) -o jsonpath='{.spec.basicDeploymentConfiguration.domain}')
              export VERIFY_URL="$(params.verify-url)"
              export VERIFY_CLIENT_ID="$(params.verify-client-id)"
              export VERIFY_CLIENT_SECRET="$(params.verify-client-secret)"
              export SCRIPTS="$(workspaces.ws.path)/cp4s-source/scripts/"
              bash $(workspaces.ws.path)/cp4s-source/scripts/cp4s-to-verify.sh
        workspaces:
          - name: ws
      workspaces:
        - name: ws
          workspace: cp4s-ws
  workspaces:
    - name: cp4s-ws

